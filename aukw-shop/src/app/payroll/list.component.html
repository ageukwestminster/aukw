<div class="row">
  <div class="card" *ngIf="qboAuthorisationMissing">
    <div class="card-body">
      <p>
        <strong>Quickbooks Online Authorisation Missing or Incomplete</strong>
      </p>
      <p>
        In order for this page to function you are required to make 2 links
        between this app and QBO.
      </p>
      <p>Making a link can be done in one of two ways:</p>
      <ul>
        <li>Log in using the "Sign in with Intuit" button.</li>
        <li>
          Using the 'Add' buttons in the Quickbooks Connections section of your
          <a routerLink="/users/edit/{{ user.id }}">Profile</a> page.
        </li>
      </ul>
      <p>
        You will be redirected to the Intuit website where you must log in using
        your Quickbooks username and password. You will then have to select
        which company file you wish to link to this app.
      </p>
      <p>
        You have to repeat the entire procedure twice: Once for the charity
        company file and once for the enterprises company file.
      </p>
    </div>
  </div>
  <div class="card m-2 col-sm-4">
    <div class="card-body">
      <h4>File Upload</h4>
      <payroll-file-upload
        (onFileUploaded)="xlsxWasUploaded($event)"
        [setButtonDisabled]="loading$ | async"
      ></payroll-file-upload>
    </div>
  </div>
  <div class="card m-2 col-sm-6">
    <div class="card-body">
      <h4>Actions</h4>
      <div class="d-flex flex-row">
        <button
          (click)="employerNI()"
          class="btn btn-sm btn-success m-1 mt-1 #employerNI"
          [disabled]="disableEmployerNI || cummulativeQbFlags.niJournalInQBO"
        >
          <span
            *ngIf="busyOnEmployerNI"
            class="spinner-border spinner-border-sm"
          ></span>
          Employer NI
        </button>
        <div class="d-flex align-items-center">
          <i class="fas fa-greater-than"></i>
        </div>
        <button
          (click)="makeEmployeeJournalEntries()"
          class="btn btn-sm btn-success m-1 mt-1"
          [disabled]="
            disableEmployeeJournals || cummulativeQbFlags.payslipJournalInQBO
          "
        >
          <span
            *ngIf="busyOnEmployeeJournals"
            class="spinner-border spinner-border-sm"
          ></span>
          Employee GJ
        </button>
        <div class="d-flex align-items-center">
          <i class="fas fa-greater-than"></i>
        </div>
        <button
          (click)="pensionBill()"
          class="btn btn-sm btn-success m-1 mt-1"
          [disabled]="disablePensions || cummulativeQbFlags.pensionBillInQBO"
        >
          <span
            *ngIf="busyOnPensions"
            class="spinner-border spinner-border-sm"
          ></span>
          Pension Bill
        </button>
        <div class="d-flex align-items-center">
          <i class="fas fa-greater-than"></i>
        </div>
        <button
          (click)="enterPayrollJournalInEnterprisesCompany()"
          class="btn btn-sm btn-success m-1 mt-1"
          [disabled]="
            disableShopJournals || cummulativeQbFlags.shopJournalInQBO
          "
        >
          <span
            *ngIf="busyOnShopJournals"
            class="spinner-border spinner-border-sm"
          ></span>
          Shop Journals
        </button>
      </div>
      <div *ngIf="loading$ | async">
        <p></p>
        <span class="spinner-border spinner-border-sm"></span>
        Loading
      </div>
    </div>
  </div>
</div>
<div
  class="progress mb-2"
  *ngIf="payslips && payslips!.length && showProgressBar"
>
  <div
    class="progress-bar progress-bar-striped progress-bar-animated bg-success"
    role="progressbar"
    [style.width.%]="(100 * currentPayslip) / payslips!.length"
    [attr.aria-valuenow]="currentPayslip"
    aria-valuemin="0"
    [attr.aria-valuemax]="payslips!.length"
  ></div>
  <div
    class="progress-bar progress-bar-striped progress-bar-animated bg-danger"
    role="progressbar"
    [style.width.%]="
      (100 * (payslips!.length - currentPayslip)) / payslips!.length
    "
    attr.aria-valuenow="{{ payslips!.length - currentPayslip }}"
    aria-valuemin="0"
    attr.aria-valuemax="{{ payslips!.length }}"
  ></div>
</div>

<div ngbAccordion class="mb-2">
  <div ngbAccordionItem [collapsed]="false" [disabled]="true">
    <h2 ngbAccordionHeader>
      <button ngbAccordionButton>Console Output</button>
    </h2>
    <div ngbAccordionCollapse>
      <div ngbAccordionBody>
        <ng-template>
          <div
            class="col-md-12"
            *ngIf="consoleMessage$ | async as consoleMessage"
          >
            <textarea style="width: 100%" cols="50" rows="10" name ="consoleTextarea">{{
              consoleMessage
            }}</textarea>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</div>
<div ngbAccordion>
  <div ngbAccordionItem [collapsed]="false">
    <h2 ngbAccordionHeader>
      <button ngbAccordionButton>Payroll Drill-down</button>
    </h2>
    <div ngbAccordionCollapse>
      <div ngbAccordionBody>
        <ng-template>
          <div
            class="d-flex flex-row justify-content-between"
            *ngIf="total && total.totalPay"
          >
            <div class="p-2">
              <p>{{ this.payslips.length }} employees</p>
            </div>
            <div class="p-2">
              <p>
                Payroll Date:
                {{ this.payslips[0].payrollDate | date: "dd MMM yyyy" }}
              </p>
            </div>
            <div class="p-2">
              <p>
                Total pension payment:
                {{
                  total.salarySacrifice +
                    total.employeePension +
                    total.employerPension | number: "1.2-2"
                }}
              </p>
            </div>
          </div>
          <table class="table table-striped table-responsive">
            <thead>
              <tr>
                <th style="width: 5%">No.</th>
                <th style="width: 22%">Name</th>
                <th style="width: 8%">Gross</th>
                <th style="width: 8%" class="d-none d-sm-table-cell">PAYE</th>
                <th style="width: 8%" class="d-none d-sm-table-cell">
                  E'ee NI
                </th>
                <th style="width: 6%" class="d-none d-sm-table-cell">Other</th>
                <th style="width: 8%" class="d-none d-sm-table-cell">S Sac</th>
                <th style="width: 8%" class="d-none d-sm-table-cell">St Loan</th>
                <th style="width: 8%" class="d-none d-sm-table-cell">Net</th>
                <th style="width: 8%" class="d-none d-sm-table-cell">
                  E'er NI
                </th>
                <th class="text-center" style="width: 8%">In QBO?</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let payslip of payslips">
                <td style="vertical-align: middle">
                  {{ payslip.payrollNumber }}
                </td>
                <td>{{ payslip.employeeName }}</td>
                <td>{{ payslip.totalPay | number: "1.2-2" }}</td>
                <td class="d-none d-sm-table-cell">
                  {{ payslip.paye | number: "1.2-2" }}
                </td>
                <td class="d-none d-sm-table-cell">
                  {{ payslip.employeeNI | number: "1.2-2" }}
                </td>
                <td class="d-none d-sm-table-cell">
                  {{ payslip.otherDeductions | number: "1.2-2" }}
                </td>
                <td class="d-none d-sm-table-cell">
                  {{
                    -payslip.salarySacrifice - payslip.employeePension
                      | number: "1.2-2"
                  }}
                </td>
                <td class="d-none d-sm-table-cell">
                  {{ payslip.studentLoan | number: "1.2-2" }}
                </td>
                <td class="d-none d-sm-table-cell">
                  {{ payslip.netPay | number: "1.2-2" }}
                </td>
                <td class="d-none d-sm-table-cell">
                  {{ payslip.employerNI | number: "1.2-2" }}
                </td>
                <td class="text-center">
                  <div class="row">
                    <div class="col">
                      <i
                        class="fas fa-minus"
                        *ngIf="!payslip.employerNI"
                        ngbTooltip="Employer NI is zero."
                      ></i>
                      <span style="color: green">
                        <i
                          class="fas fa-check"
                          *ngIf="payslip.employerNI && payslip.niJournalInQBO"
                          ngbTooltip="Employer NI journal done."
                        ></i>
                      </span>
                      <span style="color: red">
                        <i
                          class="fas fa-times"
                          *ngIf="payslip.employerNI && !payslip.niJournalInQBO"
                          ngbTooltip="Employer NI journal missing."
                        ></i>
                      </span>
                    </div>
                    <div class="col">
                      <span style="color: green">
                        <i
                          class="fas fa-check"
                          *ngIf="payslip.payslipJournalInQBO"
                          ngbTooltip="Employee payslip GJ done."
                        ></i>
                      </span>
                      <span style="color: red">
                        <i
                          class="fas fa-times"
                          *ngIf="!payslip.payslipJournalInQBO"
                          ngbTooltip="Employee payslip GJ missing."
                        ></i>
                      </span>
                    </div>
                    <div class="col">
                      <i
                        class="fas fa-minus"
                        *ngIf="!payslip.employerPension"
                        ngbTooltip="Not in pension plan."
                      ></i>
                      <span style="color: green">
                        <i
                          class="fas fa-check"
                          *ngIf="
                            payslip.employerPension && payslip.pensionBillInQBO
                          "
                          ngbTooltip="L&G pension bill done."
                        ></i>
                      </span>
                      <span style="color: red">
                        <i
                          class="fas fa-times"
                          *ngIf="
                            payslip.employerPension && !payslip.pensionBillInQBO
                          "
                          ngbTooltip="L&G pension bill missing."
                        ></i>
                      </span>
                    </div>
                    <div class="col">
                      <i
                        class="fas fa-minus"
                        *ngIf="!payslip.isShopEmployee"
                        ngbTooltip="Not a shop employee."
                      ></i>
                      <span style="color: green">
                        <i
                          class="fas fa-check"
                          *ngIf="payslip.shopJournalInQBO"
                          ngbTooltip="Shop journal entry done."
                        ></i>
                      </span>
                      <span style="color: red">
                        <i
                          class="fas fa-times"
                          *ngIf="
                            payslip.isShopEmployee && !payslip.shopJournalInQBO
                          "
                          ngbTooltip="Shop journal entry missing."
                        ></i>
                      </span>
                    </div>
                  </div>
                </td>
              </tr>
              <tr *ngIf="total && total.totalPay" style="font-weight: bold">
                <td></td>
                <td>Total for {{ this.payslips.length }} employees:</td>
                <td>{{ total.totalPay | number: "1.2-2" }}</td>
                <td class="d-none d-sm-table-cell">
                  {{ total.paye | number: "1.2-2" }}
                </td>
                <td class="d-none d-sm-table-cell">
                  {{ total.employeeNI | number: "1.2-2" }}
                </td>
                <td class="d-none d-sm-table-cell">
                  {{ total.otherDeductions | number: "1.2-2" }}
                </td>
                <td class="d-none d-sm-table-cell">
                  {{
                    -total.salarySacrifice - total.employeePension
                      | number: "1.2-2"
                  }}
                </td>
                <td class="d-none d-sm-table-cell">
                  {{ total.studentLoan | number: "1.2-2" }}
                </td>
                <td class="d-none d-sm-table-cell">
                  {{ total.netPay | number: "1.2-2" }}
                </td>
                <td class="d-none d-sm-table-cell">
                  {{ total.employerNI | number: "1.2-2" }}
                </td>
                <td></td>
              </tr>
              <tr *ngIf="!payslips">
                <td colspan="13" class="text-center">
                  <span
                    class="spinner-border spinner-border-lg align-center"
                  ></span>
                </td>
              </tr>
            </tbody>
          </table>
        </ng-template>
      </div>
    </div>
  </div>
</div>
